#!/usr/bin/env bash

set -e

readonly DOCKER_DIRECTORY=$(realpath $(dirname $(realpath $0)))
readonly VERSION_PATH=$DOCKER_DIRECTORY/../src/Version.php
readonly IMAGE_NAME="phpbenchmarks/benchmark-kit"

readonly MAJOR_VERSION=$(php -r "require('$VERSION_PATH'); echo App\Version::MAJOR;")
readonly MINOR_VERSION=$(php -r "require('$VERSION_PATH'); echo App\Version::MINOR;")
readonly PATCH_VERSION=$(php -r "require('$VERSION_PATH'); echo App\Version::PATCH;")

readonly IMAGE_PATCH_TAG=$IMAGE_NAME:$MAJOR_VERSION.$MINOR_VERSION.$PATCH_VERSION
readonly IMAGE_MINOR_TAG=$IMAGE_NAME:$MAJOR_VERSION.$MINOR_VERSION
readonly IMAGE_MAJOR_TAG=$IMAGE_NAME:$MAJOR_VERSION

echo -n "Image to build: $IMAGE_PATCH_TAG? [Y/n] "
read validate
if [ "$validate" != "" ] && [ "$validate" != "y" ] && [ "$validate" != "y" ]; then
    exit 1
fi

dockerQuiet="-q"
push=false
for param in "$@"; do
    if [ "$param" == "-v" ]; then
        dockerQuiet=""
    elif [ "$param" == "--push" ]; then
        push=true
    fi
done

echo "# composer install --no-dev"
composer install --no-dev > /dev/null 2>&1

echo "Build image..."
docker build $DOCKER_DIRECTORY/.. --file=docker/Dockerfile --tag=$IMAGE_PATCH_TAG $dockerQuiet > /dev/null
docker tag $IMAGE_PATCH_TAG $IMAGE_MINOR_TAG
docker tag $IMAGE_PATCH_TAG $IMAGE_MAJOR_TAG

if [ $push == true ]; then
    echo "# docker login --username=phpbenchmarks"
    docker login --username=phpbenchmarks

    echo "# docker push $IMAGE_PATCH_TAG"
    docker push $IMAGE_PATCH_TAG > /dev/null

    echo "# docker push $IMAGE_MINOR_TAG"
    docker push $IMAGE_MINOR_TAG > /dev/null

    echo "# docker push $IMAGE_MAJOR_TAG"
    docker push $IMAGE_MAJOR_TAG > /dev/null
fi

echo "# composer install"
composer install > /dev/null 2>&1
